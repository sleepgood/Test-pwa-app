<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reaction Time Light Game</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: black;
            color: white;
            text-align: center;
            transition: background-color 0.3s ease;
        }
        #reactionTime {
            font-size: 2em;
            margin: 20px;
        }
        #startButton {
            padding: 10px 20px;
            font-size: 1.5em;
            margin-top: 20px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>Reaction Time Game</h1>
    <div id="reactionTime">Press Start to begin!</div>
    <button id="startButton">Start</button>

    <script>
        let startButton = document.getElementById('startButton');
        let reactionTimeDisplay = document.getElementById('reactionTime');
        let startTime;
        let lightOn = false;
        let gameActive = false;
        let reactionTimeout;

        async function listenForSound() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const analyser = audioContext.createAnalyser();
                const microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                analyser.fftSize = 256;

                const dataArray = new Uint8Array(analyser.frequencyBinCount);

                function detectSound() {
                    if (!gameActive || !lightOn) {
                        requestAnimationFrame(detectSound);
                        return;
                    }

                    analyser.getByteFrequencyData(dataArray);
                    const average = dataArray.reduce((a, b) => a + b) / dataArray.length;

                    if (average > 50) { // Sound threshold for detecting a clap/snap
                        const reactionTime = Date.now() - startTime;
                        endGame(reactionTime);
                    } else {
                        requestAnimationFrame(detectSound);
                    }
                }

                detectSound();
            } catch (error) {
                console.error("Microphone access error:", error);
            }
        }

        function startGame() {
            gameActive = true;
            reactionTimeDisplay.textContent = "Get ready...";
            startButton.style.display = "none";
            lightOn = false;

            // Set a random delay before the light flashes
            const randomDelay = Math.floor(Math.random() * 3000) + 1000;

            reactionTimeout = setTimeout(() => {
                reactionTimeDisplay.textContent = "React!";
                document.body.style.backgroundColor = "red"; // Flash color
                lightOn = true;
                startTime = Date.now(); // Record start time
            }, randomDelay);
        }

        function endGame(reactionTime) {
            gameActive = false;
            lightOn = false;
            clearTimeout(reactionTimeout);
            document.body.style.backgroundColor = "black";
            reactionTimeDisplay.textContent = `Reaction Time: ${reactionTime} ms`;
            startButton.style.display = "block";
            startButton.textContent = "Play Again";
        }

        // Event listeners
        startButton.addEventListener('click', startGame);

        // Start listening for sound on load
        listenForSound();
    </script>
</body>
</html>